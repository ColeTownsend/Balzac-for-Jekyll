

<!doctype html>
<html lang="en" prefix="og: http://ogp.me/ns#">
<meta charset="utf-8">
<title>Apache Beam. A python example. &#8211; Bruno Ripa</title>
<meta name="description" content="A step-by-step guide to Apache Beam example in Python">
<meta name="keywords" content="">

<!-- DSLs for various open graph languages -->
<meta property="og:locale" content="en_EN">
<meta property="og:title" content="Apache Beam. A python example. &#8211; Bruno Ripa">
<meta property="og:description" content="A step-by-step guide to Apache Beam example in Python">
<meta property="og:url" content="/articles/apache-beam-python-example">
<meta property="og:site_name" content="Bruno Ripa">

<meta property="og:image" content="bigdata.jpeg">





<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Bruno Ripa Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Type -->
<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Crimson+Text:400,400italic,700,700italic" rel='stylesheet' type='text/css' />
<link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700" rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="/assets/css/entypo.css" media="all">

<!-- In order to use Calendas Plus, you must first purchase it. Then, create a font-face package using FontSquirrel.
<link rel='stylesheet' href='/assets/cal.css' media='all' />
-->



<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/i.css">

<!-- Fresh Squeezed jQuery -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>

<meta http-equiv="cleartype" content="on">

<!-- Load Modernizr -->
<script src="/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>


<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="/favicon.ico">

<div id="bump">
  <body class="">
    <header class="site-header">
      <div class="wrap">
        <hgroup>
          <h1><a href="/">Bruno Ripa</a></h1>
        </hgroup>
        <a href="#nav" class="menu"><span class='icons'>☰</span></a>
        <nav role="navigation">
          <ul>
            <li>
              <a href="/" title="Bruno Ripa">Home</a>
            </li>
            
            
                <li><a href="/about" >About</a></li>
            
                <li><a href="https://twitter.com/brunoripa"  target="_blank">Twitter</a></li>
            
                <li><a href="https://linkedin.com/in/brunoripa"  target="_blank">LinkedIn</a></li>
            
                <li><a href="https://github.com/brunoripa"  target="_blank">Github</a></li>
            

          </ul>
        </nav>
      </div>
    </header>


<section class="article">

  <div class="overlay"></div>
  <div class="featured-image" style="background-image: url(/images/bigdata.jpeg)"></div>


      <article class="wrap post">
        <header class="post-header">
          <hgroup>
            <h1>Apache Beam. A python example.</h1>
            <p class="intro">A step-by-step guide to Apache Beam example in Python</p>

          </hgroup>
        </header>

        <p>Nowadays, being able to handle huge amounts of data can be an interesting skill: analytics, user profiling, statistics — virtually any business that needs to extrapolate information from whatever data is, in one way or another, using some big data tools or platforms.</p>

<p>One of the most interesting tool is <a href="https://beam.apache.com">Apache Beam</a>, a framework that gives us the instruments to generate procedures to transform, process, aggregate, and manipulate data for our needs.</p>

<p>Let’s try and see how we can use it in a very simple scenario.</p>

<h2 id="the-context">The context</h2>

<p>Imagine that we have a database with information about users visiting a website, with each record containing:</p>

<ul>
  <li>country of the visiting user</li>
  <li>duration of the visit</li>
  <li>user name</li>
</ul>

<p>We want to create some reports containing:</p>

<ol>
  <li>for each country, the <strong>number of users</strong> visiting the website</li>
  <li>for each country, the <strong>average visit time</strong></li>
</ol>

<p>So, Apache Beam is a Google SDK (previously called Dataflow) representing a <strong>programming model</strong> aimed at simplifying the mechanism of large-scale data processing.</p>

<p>It’s been donated to the Apache Foundation, and called Beam because it’s able to process data in whatever form you need: <strong>batches</strong> and <strong>streams</strong> (b-eam). It gives you the chance to define <strong>pipelines</strong> to process real-time data (<strong>streams</strong> ) and historical data (<strong>batches</strong> ).</p>

<p>The pipeline definition is totally disjointed by the context that you will use to run it, so Beam gives you the chance to choose one of the supported runners you can use:</p>

<ul>
  <li>Beam model: local execution of your pipeline</li>
  <li>Google Cloud Dataflow: dataflow as a service</li>
  <li>Apache Flink</li>
  <li>Apache Spark</li>
  <li>Apache Gearpump</li>
  <li>Apache Hadoop MapReduce</li>
  <li>JStorm</li>
  <li>IBM Streams</li>
</ul>

<p>We will be running the beam model one, which basically executes everything on your local machine.</p>

<h2 id="the-programming-model">The programming model</h2>

<p>Though this is not going to be a deep explanation of the DataFlow programming model, it’s necessary to understand what a pipeline is: a set of manipulations being made on an input data set that provides a new set of data. More precisely, a pipeline is made of <strong>transforms</strong> applied to <strong>collections.</strong></p>

<p>Straight from the <a href="https://href.li/?https://beam.apache.org">Apache Beam website</a>:</p>

<blockquote>
  <p>A pipeline encapsulates your entire data processing task, from start to finish. This includes reading input data, transforming that data, and writing output data.</p>
</blockquote>

<p>The pipeline gets data injected from the outside and represents it as <strong>collections</strong> (formally named <code>PCollection</code> s ), each of them being</p>

<blockquote>
  <p>a potentially distributed, multi-element, data set</p>
</blockquote>

<p>When one or more <code>Transform</code> s are applied to a <code>PCollection</code>, a brand new <code>PCollection</code> is generated (and for this reason the resulting <code>PCollection</code> s are <strong>immutable</strong> objects).</p>

<p>The first and last step of a pipeline are, of course, the ones that can read and write data to and from several kind of storages — you can find a list <a href="https://href.li/?https://beam.apache.org/documentation/programming-guide/#pipeline-io">here</a>.</p>

<h2 id="the-application">The application</h2>

<p>We will have the data in a <code>csv</code> file, so the first thing we need to do is to read the contents of the file and provide a structured representation of all of the rows.</p>

<p>A generic row of the <code>csv</code> file will be like the following:</p>

<pre><code>United States Of America, 0.5, John Doe
</code></pre>

<p>with the columns being the <em>country</em>, the <em>visit time</em> in seconds, and the <em>user name</em>, respectively.</p>

<p>Given the data we want to provide, let’s see what our pipeline will be doing and how.</p>

<h2 id="read-the-input-data-set">Read the input data set</h2>

<p>The first step will be to read the input file.</p>

<noscript><pre>400: Invalid request
</pre></noscript>
<script src="https://gist.github.com/e693c531d7a29bf4bfb6e7cb18795a68.js"> </script>

<p>In the above context, <code>p</code> is an instance of <code>apache_beam.Pipeline</code> and the first thing that we do is to apply a built-in transform, <code>apache_beam.io.textio.ReadFromText</code> that will load the contents of the file into a <code>PCollection</code>. After this, we apply a specific logic, <code>Split</code>, to process every row in the input file and provide a more convenient representation (a dictionary, specifically).</p>

<p>Here’s the <code>Split</code> function:</p>

<noscript><pre>400: Invalid request
</pre></noscript>
<script src="https://gist.github.com/684c9fd288fbec66d057f7dff67720f2.js"> </script>

<p>The <code>ParDo</code> transform is a core one, and, as per official Apache Beam documentation:</p>

<p><code>ParDo</code> is useful for a variety of common data processing operations, including:</p>

<ul>
  <li><strong>Filtering a data set.</strong> You can use <code>ParDo</code> to consider each element in a <code>PCollection</code> and either output that element to a new collection or discard it.</li>
  <li><strong>Formatting or type-converting each element in a data set.</strong> If your input <code>PCollection</code> contains elements that are of a different type or format than you want, you can use <code>ParDo</code> to perform a conversion on each element and output the result to a new <code>PCollection</code>.</li>
  <li><strong>Extracting parts of each element in a data set.</strong> If you have a<code>PCollection</code> of records with multiple fields, for example, you can use a <code>ParDo</code> to parse out just the fields you want to consider into a new <code>PCollection</code>.</li>
  <li><strong>Performing computations on each element in a data set.</strong> You can use <code>ParDo</code> to perform simple or complex computations on every element, or certain elements, of a <code>PCollection</code> and output the results as a new <code>PCollection</code>.</li>
</ul>

<p>If you want to read more about this, please go <a href="https://beam.apache.org/documentation/programming-guide/#pardo">here</a>.</p>

<h2 id="grouping-relevant-information-under-proper-keys">Grouping relevant information under proper keys</h2>

<p>At this point, we have a list of valid rows, but we need to reorganize the information under keys that are the countries referenced by such rows. For example, if we have three rows like the following:</p>

<pre><code>Spain (ES), 2.2, John Doe
Spain (ES), 2.9, John Wayne
United Kingdom (UK), 4.2, Frank Sinatra
</code></pre>

<p>we need to rearrange the information like this:</p>

<noscript><pre>400: Invalid request
</pre></noscript>
<script src="https://gist.github.com/363eb08445e75ff245e1cc7be2242e08.js"> </script>

<p>If we do this, we have all the information in good shape to make all the calculations we need.</p>

<p>Here we go:</p>

<noscript><pre>400: Invalid request
</pre></noscript>
<script src="https://gist.github.com/a14e4f8417631fae04d73aa0e3936c81.js"> </script>

<p>The classes <code>CollectTimings</code> and <code>CollectUsers</code> basically filter the rows that are of interest for our goal. They also rearrange each of them in the right form, that is something like:</p>

<blockquote>
  <p>(“Spain (ES)”, 2.2)</p>
</blockquote>

<p>At this point, we are able to use the <code>GroupByKey</code> transform, that will create a single record that, incredibly, groups all of the info that shares the same keys:</p>

<blockquote>
  <p>(“Spain (ES)”, (2.2, 2.9))</p>
</blockquote>

<p>Note: the key is always the first element of the tuple.</p>

<p>The very last missing bit of the logic to apply is the one that has to process the values associated to each key. The built-in transform is <code>apache_beam.CombineValues</code>, which is pretty much self explanatory.</p>

<p>The logics that are applied are <code>apache_beam.combiners.MeanCombineFn</code> and <code>apache_beam.combiners.CountCombineFn</code> respectively: the former calculates the arithmetic mean, the latter counts the element of a set.</p>

<p>For the sake of completeness, here is the definition of the two classes <code>CollectTimings</code> and <code>CollectUsers</code>:</p>

<noscript><pre>400: Invalid request
</pre></noscript>
<script src="https://gist.github.com/b621882385eb179fbfb5db3096dc5531.js"> </script>

<p>Note: the operation of applying multiple times some transforms to a given <code>PCollection</code> generates multiple brand new collections. This is called <strong>collection branching</strong>. It’s very well represented here:</p>

<p><img src="https://cdn-images-1.medium.com/max/1600/1*ZaEtSYpRB1nZykP02RNp9A.png" alt="" />
<em>Source: <a href="https://beam.apache.org/images/design-your-pipeline-multiple-pcollections.png">https://beam.apache.org/images/design-your-pipeline-multiple-pcollections.png</a></em></p>

<p>Basically, now we have two sets of information — the average visit time for each country and the number of users for each country. What we’re missing is a single structure containing all of the information we want.</p>

<p>Also, having made a pipeline branching, we need to recompose the data. We can do this by using <code>CoGroupByKey</code>, which is nothing less than a <strong>join</strong> made on <em>two or more</em> collections that have the same keys.</p>

<p>The last two transforms are ones that format the info into <code>csv</code> entries while the other writes them to a file.</p>

<p>After this, the resulting <code>output.txt</code> file will contain rows like this one:</p>

<p><code>Italy (IT),36,2.23611111111</code></p>

<p>meaning that 36 people visited the website from Italy, spending, on average, 2.23 seconds on the website.</p>

<h2 id="the-input-data">The input data</h2>

<p>The data used for this simulation has been procedurally generated: 10,000 rows, with a maximum of 200 different users, spending between 1 and 5 seconds on the website. This was needed to have a rough estimate on the resulting values we obtained. A new article about <strong>pipeline testing</strong> will probably follow.</p>

<h2 id="github-repository">GitHub repository</h2>

<p>The GitHub repository for this article is <a href="https://github.com/brunoripa/beam-example">here</a>.</p>

<p>The README.md file contains everything needed to try it locally.!</p>


        <a class="share" href="https://twitter.com/intent/tweet?text=&quot;Apache Beam. A python example.&quot;%20https://brunoripa.com/articles/apache-beam-python-example%20via%20&#64;brunoripa" data-dnt="true">Share</a>
        <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

      </article>
    </section>
</div>

<div class="push"></div>
  <footer>
    <aside class="wrap">
      <ol class="prev-posts">
        <p class="list-title">Recent Posts</p>
         <!-- for1 -->
            <li>
              <span class="recent-title"><a href="/articles/genserver" title="Elixir Concurrent Programming.">Elixir Concurrent Programming. </a></span>
              <span class="date">Jul 09, 2018</span>
            </li>
         <!-- for1 -->
            <li>
              <span class="recent-title"><a href="/articles/apache-beam-python-example" title="Apache Beam. A python example.">Apache Beam. A python example. </a></span>
              <span class="date">May 28, 2018</span>
            </li>
        
      </ol>

      <div class="social">
        <ul>
            <li><a id="mail" href="mailto:bruno.ripa@gmail.com"><span class="foot-link">Contact Me</span></a></li>

            
            <li><a id="twit" href="http://twitter.com/brunoripa" target="_blank"><span class="foot-link">@brunoripa</span></a></li>
            


            
        </ul>
    </div>
    </aside>
    <small>&copy; 2018 Bruno Ripa.</small>
  </footer>

  <!-- If they're out, get some from the cellar -->
  <script>window.jQuery || document.write('<script src="/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
  <script src="/assets/js/retina.min.js"></script>

  <!-- Custom JS -->
  <script src="/assets/js/scripts.js"></script>

  <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    
      ga('create', 'UA-XXXXXXXX-X', 'auto');
      ga('send', 'pageview');
  </script>
  </body>
</html>

